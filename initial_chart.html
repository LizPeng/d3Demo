<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: All vehicles</title>
		<script type="text/javascript" src="./d3.js"></script>
		<style type="text/css">
		h1 {
				font-family: Helvetica, sans-serif;
				font-size: 14px;
				font-weight: bold;
			}

			.area {
				stroke: none;
			}

			.area:hover {
				fill: yellow;
			}	
		</style>
	</head>
	<body>
    <h1>Monthly Number of Electric-Drive Vehicles Sold in the U.S.: January 2005&ndash;February 2017</h1>
		<script type="text/javascript">
      //Width and height
			var w = 800;
			var h = 500;
			var padding = 20;
			
			var dataset, xScale, yScale, xAxis, yAxis, area;  //Empty, for now
      // for converting strings to Dates
      var parseTime = d3.timeParse("%Y-%m")
      // for converting Dates to Strings
      var formatTime = d3.timeFormat("%b %Y")
      // set up stack method
      var stack = d3.stack()
        .order(d3.stackOrderDescending) // flipped stacking order

      // load in data 
      d3.request("vehicle_sales_data.csv")
        .mimeType("text/csv")
        .get(function(response) {
          // data parsing
          // parse each row of the csv into an array of string values
          var rows = d3.csvParseRows(response.responseText)
          // console.log(rows)
          
          // make dateset an empty array,so we can start adding values
          dataset = []

          // loop once for each row of the csv ,starting at row 3
          // since rows 0-2 contain only vehicle info, not sales value.
          for(var i = 3; i< rows.length;i++) {
            // create a new object
            dataset[i - 3] = {
              date: parseTime(rows[i][0]) // make a new date object for each year + month
            }
            // loop once for each vehicle in this row
            for(var j = 1; j<rows[i].length; j++) {
              var make		= rows[0][j];  //'Make' from 1st row in CSV
							var model		= rows[1][j];  //'Model' from 2nd row in CSV
							var makeModel	= rows[0][j] + " " + rows[1][j];  //'Make' + 'Model' will serve as our key
							var type 		= rows[2][j];  //'Type' from 3rd row in CSV
							var sales		= rows[i][j];  //Sales value for this vehicle and month
              
              // if sales value exists..
              if(sales) {
                sales = parseInt(sales)
              }else {
                sales = 0
              }

              // append a new object with data for this vehicle and month 
              dataset[i-3][makeModel] = {
                "make": make,
								"model": model,
								"type": type,
								"sales": sales
              }
            }
          }
          // logout the final state of dataset
          // console.log(dataset)

          //
          //STACKING
          //

          // now that we know the column names in the data,
          // get all the keys (make + model), but toss out 'date'
          var keys = Object.keys(dataset[0]).slice(1);
          // console.log(keys)

          // tell stack function where to find the keys
          stack.keys(keys)
            .value(function value(d,key) {
              return d[key].sales;
            })
          
          // tell the data and log it out
          var series = stack(dataset);
           console.log(series)
            
          //
          // MAKE THE CHART

          // create scale functions
          xScale = d3.scaleTime()
            .domain([
              d3.min(dataset, function(d) { return d.date; }),
							d3.max(dataset, function(d) { return d.date; })
            ])  
            .range([padding, w - padding * 2])

          yScale = d3.scaleLinear()
            .domain([
              0,
              d3.max(dataset, function(d) {
                var sum = 0;
                // loops once for each now, to calculate
                // the total (sum) of sales of all vehicles
                for( var i = 0; i< keys.length; i++) {
                  sum += d[keys[i]].sales;
                }
                return sum;
              })
            ])
            .range([h - padding, padding / 2])
            .nice()

            // define axes
            xAxis = d3.axisBottom()
              .scale(xScale)
              .ticks(10)
              .tickFormat(formatTime)
            // define y axis
            yAxis = d3.axisRight()
              .scale(yScale)
              .ticks(5)
            // define area generator
            area = d3.area()
              .x(function(d) { return xScale(d.data.date)})
              .y0(function(d) {return yScale(d[0]) })
              .y1(function(d) {return yScale(d[1]) })

            //create svg element
            var svg = d3.select("body")
              .append("svg")
              .attr("width", w)
              .attr("height", h)
            
            // create areas
            svg.selectAll("path")
              .data(series)
              .enter()
              .append("path")
              .attr("class", "area")
              .attr("d", area)
              .attr("fill", function(d, i) {
                return d3.schemeCategory20[i]
              })
              .append("title")
              .text(function(d) {
                return d.key
              })

              //create axes
              svg.append("g")
                .attr("class", "axis x")
                .attr("transform", "translate(0," + (h-padding) + ")")
                .call(xAxis);
              
              svg.append("g")
                .attr("class", "axis y")
                .attr("transform", "translate(" + (w - padding * 2) + ",0)")
						    .call(yAxis);
        })
		</script>
	</body>
</html>